name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-manager:
    uses: ./.github/workflows/build-manager.yml
    secrets: inherit

  release:
    needs:
      - build-manager
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7

      - name: Prepare and Rename Assets
        run: |
          # 1. Rename APK agar tidak ada nama yang sama (Conflict)
          # Cari di folder Manager-release
          if [ -d "Manager-release" ]; then
            find Manager-release -name "*.apk" -exec mv {} . \;
          fi
          # Cari di folder Spoofed-Manager-release, tambah suffix -spoofed
          if [ -d "Spoofed-Manager-release" ]; then
            find Spoofed-Manager-release -name "*.apk" -exec sh -c 'mv "$1" "${1%.apk}-spoofed.apk"' _ {} \;
            find Spoofed-Manager-release -name "*-spoofed.apk" -exec mv {} . \;
          fi

          # 2. Rename ksud
          mkdir -p ksud
          for dir in ./ksud-*; do
              if [ -d "$dir" ]; then
                 echo "----- Rename $dir -----"
                 ksud_platform_name=$(basename "$dir")
                 find "$dir" -type f -name "ksud" -path "*/release/*" | while read -r ksud_file; do
                   if [ -f "$ksud_file" ]; then
                     mv "$ksud_file" "ksud/$ksud_platform_name"
                   fi
                 done
              fi
          done

          # 3. Zip Kernel Modules (AnyKernel, WSA, ARCVM)
          # Kita gabungkan loop nya agar lebih bersih
          for dir in AnyKernel3-* kernel-WSA-* kernel-ARCVM-*; do
            if [ -d "$dir" ]; then
              echo "----- Zip $dir -----"
              (cd "$dir" && zip -r9 "../$dir".zip ./* -x .git .gitignore ./*.zip)
            fi
          done

          # 4. Pindahkan .ko files ke root agar mudah di upload
          find android*-lkm -name "*.ko" -exec mv {} . \; 2>/dev/null || true

      - name: Display structure of downloaded files
        run: ls -R

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          # PERBAIKAN: Gunakan tag_name, bukan tag
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('ci-build-{0}', github.run_number) || github.ref_name }}
          files: |
            *.apk
            *.ko
            AnyKernel3-*.zip
            kernel-WSA*.zip
            kernel-ARCVM*.zip
            boot-images-*/Image-*/*.img.gz
            ksud/ksud-*
